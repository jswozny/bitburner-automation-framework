import { NS } from "@ns";

// === TYPES ===

export interface ExploitResult {
  hostname: string;
  success: boolean;
  alreadyRooted: boolean;
  portsOpened: string[];
}

// === CORE LOGIC ===

/**
 * Count available port-opening tools
 */
export function countAvailableTools(ns: NS): number {
  const tools = [
    "BruteSSH.exe",
    "FTPCrack.exe",
    "HTTPWorm.exe",
    "SQLInject.exe",
    "relaySMTP.exe",
  ];
  return tools.filter((t) => ns.fileExists(t, "home")).length;
}

/**
 * Open all available ports on a target server
 */
export function openPorts(ns: NS, target: string): string[] {
  const opened: string[] = [];

  if (ns.fileExists("BruteSSH.exe", "home")) {
    ns.brutessh(target);
    opened.push("SSH");
  }

  if (ns.fileExists("FTPCrack.exe", "home")) {
    ns.ftpcrack(target);
    opened.push("FTP");
  }

  if (ns.fileExists("HTTPWorm.exe", "home")) {
    ns.httpworm(target);
    opened.push("HTTP");
  }

  if (ns.fileExists("SQLInject.exe", "home")) {
    ns.sqlinject(target);
    opened.push("SQL");
  }

  if (ns.fileExists("relaySMTP.exe", "home")) {
    ns.relaysmtp(target);
    opened.push("SMTP");
  }

  return opened;
}

/**
 * Attempt to nuke a server after opening ports
 * Returns result with details about what happened
 */
export function exploitServer(ns: NS, target: string): ExploitResult {
  if (ns.hasRootAccess(target)) {
    return {
      hostname: target,
      success: true,
      alreadyRooted: true,
      portsOpened: [],
    };
  }

  const portsOpened = openPorts(ns, target);

  try {
    ns.nuke(target);
    return {
      hostname: target,
      success: true,
      alreadyRooted: false,
      portsOpened,
    };
  } catch {
    return {
      hostname: target,
      success: false,
      alreadyRooted: false,
      portsOpened,
    };
  }
}

// === RUNNER ===

export async function main(ns: NS): Promise<void> {
  const target = ns.args[0] as string;

  if (!target) {
    ns.tprint("ERROR: No target specified. Usage: run exploit.ts <hostname>");
    return;
  }

  const result = exploitServer(ns, target);

  if (result.alreadyRooted) {
    ns.tprint(`Already have root access on ${target}. Exiting.`);
  } else if (result.success) {
    ns.tprint(`SUCCESS: Acquired root access on ${target}!`);
  } else {
    ns.tprint(`FAILED: Could not nuke ${target}.`);
  }
}
